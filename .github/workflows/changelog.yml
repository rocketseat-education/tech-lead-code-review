name: Validar Commits e Gerar Changelog

# Quando o workflow deve executar
on:
  push:
    branches: [main, master] # Executa quando há push para main ou master
  pull_request:
    branches: [main, master] # Executa quando há PR para main ou master

jobs:
  # Job 1: Valida se os commits seguem o padrão Conventional Commits
  validate-commits:
    name: Validar Commits
    runs-on: ubuntu-latest

    steps:
      # Baixa o código do repositório
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Baixa todo o histórico (necessário para validar commits)

      # Configura o Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm" # Cache das dependências para acelerar builds

      # Instala as dependências do projeto
      - name: Instalar dependências
        run: npm ci

      # Valida os commits usando commitlint
      - name: Validar commits
        run: |
          # Valida todos os commits novos (do último commit até HEAD)
          npx commitlint --from HEAD~1 --to HEAD --verbose

  # Job 2: Gera o changelog automaticamente após validação bem-sucedida
  generate-changelog:
    name: Gerar Changelog
    runs-on: ubuntu-latest
    needs: validate-commits # Só executa se a validação passar
    # Só gera changelog em pushes (não em PRs)
    if: github.event_name == 'push'

    # Permissões necessárias para fazer commit e push
    permissions:
      contents: write

    steps:
      # Baixa o código com token para poder fazer push
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Configura o Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Instala as dependências
      - name: Instalar dependências
        run: npm ci

      # Configura o Git com nome e email para os commits
      - name: Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # Gera o changelog usando o script do package.json
      - name: Gerar Changelog
        run: npm run version

      # Faz commit e push do changelog atualizado
      - name: Commit e Push do Changelog
        run: |
          git add CHANGELOG.md
          git commit -m "chore: atualizar changelog [skip ci]"
          git push
        # [skip ci] evita que o workflow execute novamente em loop
